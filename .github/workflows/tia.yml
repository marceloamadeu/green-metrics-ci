name: TIA Energy Optimization Protocol

on: [push, pull_request]

jobs:
  green-test-execution:
    name: Green Test Runner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Necessário para o testmon analisar histórico git

      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip' # Cache de dependências pip para economizar energia de download

      # CORREÇÃO CRÍTICA: Espaço adicionado em 'path'
      # Isso habilita a persistência da inteligência da TIA
      - name: Cache Testmon Database
        uses: actions/cache@v3
        with:
          path: .testmondata 
          key: testmon-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            testmon-${{ runner.os }}-

      - name: Install System Dependencies
        run: pip install -r requirements.txt pytest pytest-testmon

      - name: Execute Orchestrator
        # Invoca o script Python corrigido
        run: python scripts/orchestrator.py
        env:
          # Token necessário se o orquestrador interagir com a API do GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}